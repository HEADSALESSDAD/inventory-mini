<!-- app/templates/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Mini</title>

  <!-- Bootstrap (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Your CSS -->
  <link href="/static/style.css" rel="stylesheet">
</head>

<body>
<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    <aside class="col-12 col-md-3 col-lg-2 p-3 sidebar">
      <div class="d-flex align-items-center gap-2 mb-4">
        <div class="brand-badge">IM</div>
        <div>
          <div class="text-white fw-bold">Inventory Mini</div>
          <div class="text-secondary small">Warehouse UI</div>
        </div>
      </div>

      <nav class="d-grid gap-2">
        <a href="/">Inventory</a>
        <a href="/reports">Reports (Excel/PDF)</a>
        <a href="/docs" target="_blank">API Docs (Swagger)</a>
        <a href="/health" target="_blank">Health</a>
      </nav>

      <div class="text-secondary small mt-4">
        Tip: Swagger is for testing APIs, not for real users.
      </div>
    </aside>

    <!-- Main -->
    <main class="col-12 col-md-9 col-lg-10 p-4">

      <!-- Header -->
      <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
        <div>
          <h3 class="mb-0">Inventory Dashboard</h3>
          <div class="text-secondary">Clean UI, fast exports, simple CRUD.</div>
        </div>

        <div class="d-flex gap-2">
          <a class="btn btn-outline-dark rounded-16" href="/export/items.xlsx">Download Excel</a>
          <a class="btn btn-outline-dark rounded-16" href="/export/items.pdf">Download PDF (A4)</a>
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
          <div class="card card-kpi p-3">
            <div class="text-secondary">Total Rows</div>
            <div class="fs-3 fw-bold">{{ total_rows }}</div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="card card-kpi p-3">
            <div class="text-secondary">Total Quantity</div>
            <div class="fs-3 fw-bold">{{ total_qty }}</div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="card card-kpi p-3">
            <div class="text-secondary">Estimated Stock Value</div>
            <div class="fs-3 fw-bold">{{ "%.2f"|format(total_value) }}</div>
          </div>
        </div>
      </div>

      <!-- Add / Update Form -->
      <div class="card card-kpi p-3 mb-4">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Add / Update Item</h5>
          <button class="btn btn-sm btn-outline-secondary rounded-16" onclick="clearForm()">Clear</button>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-12 col-md-2">
            <label class="form-label">ID (for update)</label>
            <input id="f-id" type="number" class="form-control" placeholder="Leave empty to create">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Name</label>
            <input id="f-name" type="text" class="form-control" placeholder="e.g., Oil Filter">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">SKU</label>
            <input id="f-sku" type="text" class="form-control" placeholder="e.g., TOY-OF-90915">
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Qty</label>
            <input id="f-qty" type="number" class="form-control" value="0" min="0">
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">Price (optional)</label>
            <input id="f-price" type="number" class="form-control" step="0.01" min="0" placeholder="e.g., 12.50">
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-teal rounded-16" onclick="saveItem()">Save</button>
          <div id="msg" class="text-secondary align-self-center"></div>
        </div>
      </div>

      <!-- Table -->
      <div class="card card-kpi p-3">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
          <h5 class="mb-0">Items</h5>

          <input id="search" class="form-control" style="max-width: 320px;" placeholder="Search by name or SKU..." oninput="filterTable()">
        </div>

        <div class="table-responsive">
          <table class="table align-middle table-hover">
            <thead>
              <tr>
                <th style="width: 90px;">Actions</th>
                <th style="width: 70px;">ID</th>
                <th>Name</th>
                <th style="width: 200px;">SKU</th>
                <th style="width: 90px;">Qty</th>
                <th style="width: 120px;">Price</th>
              </tr>
            </thead>
            <tbody id="tbody">
              {% for it in items %}
              <tr>
                <td>
                  <button class="btn btn-sm btn-outline-primary rounded-16" onclick="loadForEdit({{it.id}}, '{{it.name|e}}', '{{it.sku|e}}', {{it.qty}}, {{ 'null' if it.price is none else it.price }})">Edit</button>
                  <button class="btn btn-sm btn-outline-danger rounded-16" onclick="deleteItem({{it.id}})">Del</button>
                </td>
                <td>{{ it.id }}</td>
                <td>{{ it.name }}</td>
                <td>{{ it.sku }}</td>
                <td>{{ it.qty }}</td>
                <td>{% if it.price is none %}-{% else %}{{ "%.2f"|format(it.price) }}{% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </main>
  </div>
</div>

<script>
  // Beginner note:
  // We keep JS super simple:
  // - Save = POST (create) or PUT (update)
  // - Then refresh the page

  function setMsg(text) {
    document.getElementById("msg").innerText = text;
  }

  function clearForm() {
    document.getElementById("f-id").value = "";
    document.getElementById("f-name").value = "";
    document.getElementById("f-sku").value = "";
    document.getElementById("f-qty").value = 0;
    document.getElementById("f-price").value = "";
    setMsg("");
  }

  function loadForEdit(id, name, sku, qty, price) {
    document.getElementById("f-id").value = id;
    document.getElementById("f-name").value = name;
    document.getElementById("f-sku").value = sku;
    document.getElementById("f-qty").value = qty;
    document.getElementById("f-price").value = (price === null ? "" : price);
    setMsg("Edit mode: change fields and click Save.");
  }

  async function saveItem() {
    const id = document.getElementById("f-id").value.trim();
    const name = document.getElementById("f-name").value.trim();
    const sku = document.getElementById("f-sku").value.trim();
    const qty = Number(document.getElementById("f-qty").value || 0);
    const priceRaw = document.getElementById("f-price").value.trim();
    const price = priceRaw === "" ? null : Number(priceRaw);

    if (!name || !sku) {
      setMsg("Name and SKU are required.");
      return;
    }

    setMsg("Saving...");

    try {
      if (id === "") {
        // Create (POST)
        const res = await fetch("/items", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({name, sku, qty, price})
        });
        if (!res.ok) throw new Error("Create failed");
      } else {
        // Update (PUT)
        const res = await fetch(`/items/${id}`, {
          method: "PUT",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({name, sku, qty, price})
        });
        if (!res.ok) throw new Error("Update failed");
      }

      location.reload(); // simplest way
    } catch (e) {
      setMsg("Error: " + e.message);
    }
  }

  async function deleteItem(id) {
    if (!confirm("Delete this item?")) return;

    setMsg("Deleting...");
    try {
      const res = await fetch(`/items/${id}`, { method: "DELETE" });
      if (!res.ok) throw new Error("Delete failed");
      location.reload();
    } catch (e) {
      setMsg("Error: " + e.message);
    }
  }

  function filterTable() {
    const q = document.getElementById("search").value.toLowerCase().trim();
    const rows = document.querySelectorAll("#tbody tr");
    rows.forEach(r => {
      const name = r.children[2].innerText.toLowerCase();
      const sku = r.children[3].innerText.toLowerCase();
      r.style.display = (name.includes(q) || sku.includes(q)) ? "" : "none";
    });
  }
</script>

</body>
</html>



