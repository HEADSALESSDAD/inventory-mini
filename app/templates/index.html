<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory Mini | Warehouse UI</title>

  <!-- Optional font (falls back to system if blocked) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0B1220;
      --panel: #0F172A;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --text: #E5E7EB;
      --muted: #94A3B8;
      --line: rgba(148,163,184,.25);
      --brand: #38BDF8;     /* sky */
      --brand2:#22C55E;     /* green */
      --warn: #F59E0B;
      --danger:#EF4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(56,189,248,.18), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.14), transparent 55%),
                  radial-gradient(900px 500px at 50% 95%, rgba(245,158,11,.10), transparent 50%),
                  var(--bg);
      color: var(--text);
    }

    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 35%), var(--panel);
      border-right:1px solid var(--line);
      padding:18px;
      position: sticky;
      top:0;
      height: 100vh;
    }

    .logo{
      display:flex;
      gap:10px;
      align-items:center;
      padding:14px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    .mark{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(34,197,94,.85));
      display:grid;place-items:center;
      font-weight:800;color:#081018;
    }
    .logo h1{ font-size:14px; margin:0; letter-spacing:.3px; }
    .logo p{ font-size:12px; margin:2px 0 0; color:var(--muted); }

    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top: 12px;
    }
    .nav a{
      text-decoration:none;
      color: var(--text);
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid transparent;
      background: rgba(255,255,255,.03);
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:.15s;
    }
    .nav a:hover{
      border-color: rgba(56,189,248,.35);
      background: rgba(56,189,248,.07);
    }
    .pill{
      font-size:11px;
      color: #081018;
      background: rgba(56,189,248,.95);
      padding:2px 8px;
      border-radius:999px;
      font-weight:700;
    }

    /* Main */
    .main{
      padding:22px;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
    }
    .title h2{ margin:0; font-size:20px; }
    .title span{ color: var(--muted); font-size:12px; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s;
      font-weight:700;
      font-size:13px;
    }
    .btn:hover{ background: rgba(255,255,255,.08); }
    .btn.primary{ border-color: rgba(56,189,248,.35); background: rgba(56,189,248,.12); }
    .btn.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .btn.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }
    .btn.danger{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top: 14px;
    }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(140px, 1fr));
      gap:12px;
    }
    .kpi{
      padding:12px;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:18px; font-weight:800; margin-top:6px; }

    .formgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .field label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
    }
    .field input{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    .field input:focus{
      border-color: rgba(56,189,248,.5);
      box-shadow: 0 0 0 3px rgba(56,189,248,.12);
    }

    .tablewrap{
      overflow:auto;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      margin-top: 12px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 860px;
    }
    thead th{
      position: sticky;
      top:0;
      background: rgba(15,23,42,.95);
      backdrop-filter: blur(6px);
      text-align:left;
      font-size:12px;
      color: var(--muted);
      padding:12px;
      border-bottom:1px solid var(--line);
    }
    tbody td{
      padding:12px;
      border-bottom:1px solid rgba(148,163,184,.14);
      font-size:13px;
    }
    tbody tr:hover{ background: rgba(56,189,248,.06); }

    .row-actions{
      display:flex;
      gap:8px;
    }
    .tiny{
      padding:7px 10px;
      border-radius: 10px;
      font-size:12px;
      font-weight:800;
    }

    .searchbar{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top: 10px;
    }
    .searchbar input{
      flex:1;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }

    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: rgba(15,23,42,.95);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: 14px;
      padding:12px 14px;
      min-width: 260px;
      display:none;
    }
    .toast strong{ display:block; margin-bottom:4px; }
    .toast small{ color: var(--muted); }

    .loading{
      display:flex;
      gap:10px;
      align-items:center;
      color: var(--muted);
      margin-top: 8px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(56,189,248,.8);
      box-shadow: 0 0 0 6px rgba(56,189,248,.10);
      animation: pulse 1.2s infinite ease-in-out;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity:.7; }
      50%{ transform: scale(1.25); opacity:1; }
    }

    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position: relative; height:auto; }
      .grid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">
        <div class="mark">IM</div>
        <div>
          <h1>Inventory Mini</h1>
          <p>Warehouse UI</p>
        </div>
      </div>

      <div class="nav">
        <a href="#" onclick="scrollToSection('inventory'); return false;">
          Inventory <span class="pill" id="pill-count">0</span>
        </a>
        <a href="/docs" target="_blank">Swagger (API Docs) <span class="pill">API</span></a>
        <a href="/export/items.xlsx">Export Excel (.xlsx) <span class="pill">XLSX</span></a>
        <a href="/export/items.pdf">Export PDF (A4) <span class="pill">PDF</span></a>
        <a href="/health" target="_blank">Health Check <span class="pill">OK</span></a>
      </div>

      <div class="card" style="margin-top:14px;">
        <div style="font-weight:800; margin-bottom:6px;">Quick Notes</div>
        <div style="color:var(--muted); font-size:12px; line-height:1.5;">
          - Use the form to create or update items.<br>
          - Leave ID empty to create a new item.<br>
          - Click Edit to load an item into the form.
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2>Inventory Dashboard</h2>
          <span>Clean UI, English-only, exports included.</span>
        </div>

        <div class="actions">
          <button class="btn primary" onclick="refreshAll()">Refresh</button>
          <a class="btn good" href="/export/items.xlsx">Download Excel</a>
          <a class="btn warn" href="/export/items.pdf">Download PDF (A4)</a>
        </div>
      </div>

      <section class="card">
        <div class="kpis">
          <div class="kpi">
            <div class="label">Total Items</div>
            <div class="value" id="kpi-items">0</div>
          </div>
          <div class="kpi">
            <div class="label">Total Rows</div>
            <div class="value" id="kpi-rows">0</div>
          </div>
          <div class="kpi">
            <div class="label">Total QTY</div>
            <div class="value" id="kpi-qty">0</div>
          </div>
          <div class="kpi">
            <div class="label">Approx. Value</div>
            <div class="value" id="kpi-value">0</div>
          </div>
        </div>

        <div class="loading" id="loading">
          <div class="dot"></div>
          <div>Loading inventory…</div>
        </div>

        <div class="grid" id="inventory">
          <div class="card" style="background: rgba(255,255,255,.03);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="font-weight:800;">Items</div>
              <div style="color:var(--muted); font-size:12px;">Search, sort, manage</div>
            </div>

            <div class="searchbar">
              <input id="search" placeholder="Search by ID / Name / SKU…" oninput="applyFilter()" />
              <button class="btn" onclick="clearSearch()">Clear</button>
            </div>

            <div class="tablewrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:70px;">ID</th>
                    <th>Name</th>
                    <th style="width:170px;">SKU</th>
                    <th style="width:90px;">QTY</th>
                    <th style="width:110px;">Price</th>
                    <th style="width:120px;">Value</th>
                    <th style="width:180px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </div>

          <div class="card" style="background: rgba(255,255,255,.03);">
            <div style="font-weight:800;">Add / Update Item</div>
            <div style="color:var(--muted); font-size:12px; margin-top:6px;">
              Leave ID empty to create a new item.
            </div>

            <div class="formgrid">
              <div class="field">
                <label>Item ID (optional)</label>
                <input id="f_id" placeholder="e.g., 12" />
              </div>
              <div class="field">
                <label>QTY</label>
                <input id="f_qty" placeholder="e.g., 10" type="number" />
              </div>
              <div class="field">
                <label>Name</label>
                <input id="f_name" placeholder="e.g., Oil Filter" />
              </div>
              <div class="field">
                <label>SKU</label>
                <input id="f_sku" placeholder="e.g., TOY-OF-90915" />
              </div>
              <div class="field">
                <label>Price (optional)</label>
                <input id="f_price" placeholder="e.g., 25.50" type="number" step="0.01" />
              </div>
              <div class="field">
                <label>&nbsp;</label>
                <button class="btn good" onclick="saveItem()">Save</button>
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
              <button class="btn" onclick="resetForm()">Reset Form</button>
              <button class="btn danger" onclick="deleteById()">Delete by ID</button>
            </div>

            <div style="margin-top:12px; color:var(--muted); font-size:12px; line-height:1.5;">
              Tip: Click <b>Edit</b> in the table to auto-fill the form.
            </div>
          </div>
        </div>
      </section>

      <div class="toast" id="toast">
        <strong id="toastTitle">Done</strong>
        <small id="toastMsg">Message</small>
      </div>
    </main>
  </div>

  <script>
    // In-memory cache so we can filter without re-fetching every keypress
    let ALL_ITEMS = [];

    function scrollToSection(id){
      document.getElementById(id)?.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function showToast(title, msg){
      const t = document.getElementById('toast');
      document.getElementById('toastTitle').textContent = title;
      document.getElementById('toastMsg').textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 2600);
    }

    function money(n){
      if(n === null || n === undefined || n === "") return "";
      const x = Number(n);
      if(Number.isNaN(x)) return "";
      return x.toFixed(2);
    }

    function calcValue(it){
      if(it.price === null || it.price === undefined) return null;
      return Number(it.qty) * Number(it.price);
    }

    function setLoading(isLoading){
      document.getElementById('loading').style.display = isLoading ? 'flex' : 'none';
    }

    async function refreshAll(){
      setLoading(true);
      try{
        const res = await fetch('/items');
        if(!res.ok) throw new Error('Failed to load items');
        ALL_ITEMS = await res.json();

        // Update KPI + pill
        document.getElementById('kpi-rows').textContent = ALL_ITEMS.length;

        // Count distinct SKU
        const skuSet = new Set(ALL_ITEMS.map(x => (x.sku || '').trim()).filter(Boolean));
        document.getElementById('kpi-items').textContent = skuSet.size;
        document.getElementById('pill-count').textContent = ALL_ITEMS.length;

        // Total qty
        const totalQty = ALL_ITEMS.reduce((s,x) => s + Number(x.qty || 0), 0);
        document.getElementById('kpi-qty').textContent = totalQty;

        // Approx value
        const totalVal = ALL_ITEMS.reduce((s,x) => {
          const v = calcValue(x);
          return s + (v ? v : 0);
        }, 0);
        document.getElementById('kpi-value').textContent = money(totalVal);

        renderTable(ALL_ITEMS);
      }catch(e){
        showToast('Error', String(e));
      }finally{
        setLoading(false);
      }
    }

    function renderTable(items){
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';

      for(const it of items){
        const tr = document.createElement('tr');

        const value = calcValue(it);
        tr.innerHTML = `
          <td>${it.id}</td>
          <td>${escapeHtml(it.name ?? '')}</td>
          <td>${escapeHtml(it.sku ?? '')}</td>
          <td>${Number(it.qty ?? 0)}</td>
          <td>${it.price == null ? '' : money(it.price)}</td>
          <td>${value == null ? '' : money(value)}</td>
          <td>
            <div class="row-actions">
              <button class="btn tiny primary" onclick="loadToForm(${it.id})">Edit</button>
              <button class="btn tiny danger" onclick="deleteItem(${it.id})">Delete</button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      }
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function applyFilter(){
      const q = (document.getElementById('search').value || '').trim().toLowerCase();
      if(!q){
        renderTable(ALL_ITEMS);
        return;
      }
      const filtered = ALL_ITEMS.filter(it => {
        const id = String(it.id ?? '');
        const name = String(it.name ?? '').toLowerCase();
        const sku = String(it.sku ?? '').toLowerCase();
        return id.includes(q) || name.includes(q) || sku.includes(q);
      });
      renderTable(filtered);
    }

    function clearSearch(){
      document.getElementById('search').value = '';
      renderTable(ALL_ITEMS);
    }

    function resetForm(){
      document.getElementById('f_id').value = '';
      document.getElementById('f_name').value = '';
      document.getElementById('f_sku').value = '';
      document.getElementById('f_qty').value = '';
      document.getElementById('f_price').value = '';
    }

    async function loadToForm(id){
      try{
        const res = await fetch(`/items/${id}`);
        if(!res.ok) throw new Error('Item not found');
        const it = await res.json();
        document.getElementById('f_id').value = it.id ?? '';
        document.getElementById('f_name').value = it.name ?? '';
        document.getElementById('f_sku').value = it.sku ?? '';
        document.getElementById('f_qty').value = it.qty ?? '';
        document.getElementById('f_price').value = it.price ?? '';
        showToast('Loaded', `Item #${id} loaded into form`);
      }catch(e){
        showToast('Error', String(e));
      }
    }

    function readForm(){
      const idRaw = document.getElementById('f_id').value.trim();
      const name = document.getElementById('f_name').value.trim();
      const sku  = document.getElementById('f_sku').value.trim();
      const qty  = Number(document.getElementById('f_qty').value);
      const priceRaw = document.getElementById('f_price').value.trim();

      if(!name) throw new Error('Name is required');
      if(!sku) throw new Error('SKU is required');
      if(Number.isNaN(qty)) throw new Error('QTY must be a number');

      const price = priceRaw === '' ? null : Number(priceRaw);
      if(priceRaw !== '' && Number.isNaN(price)) throw new Error('Price must be a number');

      return {
        id: idRaw === '' ? null : Number(idRaw),
        payload: { name, sku, qty, price }
      };
    }

    async function saveItem(){
      try{
        const { id, payload } = readForm();

        // If ID exists -> PUT, else -> POST
        if(id){
          const res = await fetch(`/items/${id}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!res.ok) throw new Error('Update failed');
          showToast('Updated', `Item #${id} updated`);
        }else{
          const res = await fetch('/items', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!res.ok) throw new Error('Create failed');
          showToast('Created', `New item created`);
        }

        resetForm();
        await refreshAll();
      }catch(e){
        showToast('Error', String(e));
      }
    }

    async function deleteItem(id){
      if(!confirm(`Delete item #${id}?`)) return;
      try{
        const res = await fetch(`/items/${id}`, { method:'DELETE' });
        if(!res.ok) throw new Error('Delete failed');
        showToast('Deleted', `Item #${id} deleted`);
        await refreshAll();
      }catch(e){
        showToast('Error', String(e));
      }
    }

    async function deleteById(){
      const idRaw = document.getElementById('f_id').value.trim();
      if(!idRaw) return showToast('Info', 'Enter an ID first');
      const id = Number(idRaw);
      if(Number.isNaN(id)) return showToast('Error', 'ID must be a number');
      await deleteItem(id);
      resetForm();
    }

    // Boot
    refreshAll();
  </script>
</body>
</html>
